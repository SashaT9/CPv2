<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Contest Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        /* Menu panel css */
        a {
            color: inherit;
            text-decoration: inherit;
        }

        .menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid black;
            background-color: #fff;
            z-index: 1000;
            padding: 0 20px;
        }

        .menu-left {
            display: flex;
            gap: 10px;
        }

        .menu-right {
            display: flex;
            align-items: center;
        }

        .menu-item {
            padding: 10px 20px;
            text-align: center;
            flex-grow: 1;
            margin: 0 5px;
            font-weight: 500;
        }

        /* End */
        .container {
            display: flex;
            margin: 50px auto;
            max-width: 1200px;
            padding: 20px;
        }

        .content {
            flex: 3;
            margin-right: 20px;
        }

        .user-info {
            flex: 1;
            background-color: white;
            padding: 5px 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            height: 250px;
            margin-left: 20px;
            font-size: medium;
            text-align: end;
            max-width: 210px;
            position: sticky;
            top: 65px;
        }

        .problem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .problem h3 {
            margin-top: 0;
            margin-bottom: 0;
            font-size: medium;
        }

        .problem-list {
            margin-top: 20px;
        }

        .create-announcement-form {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .create-announcement-form input[type="text"],
        .create-announcement-form textarea {
            width: 97%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .create-announcement-form button {
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .announcement {
            background-color: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .announcement h3 {
            margin-top: 0;
        }

        .announcement-actions {
            margin-top: 10px;
            text-align: right;
        }

        .announcement-actions button {
            padding: 5px 10px;
            margin-left: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #4caf50;
            color: white;
            cursor: pointer;
        }

        .announcement-actions button.delete {
            background-color: #f44336;
        }

        .announcement-actions button:hover {
            opacity: 0.8;
        }

        .update-announcement-form {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }

        .update-announcement-form input[type="text"],
        .update-announcement-form textarea {
            width: 97%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }

        .update-announcement-form button {
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .announcement-list {
            margin-top: 20px;
        }

        .problem-actions {
            /* margin-top: 10px; */
            text-align: right;
        }

        .problem-actions button {
            padding: 5px 10px;
            /* margin-left: 10px; */
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f44336;
            color: white;
            cursor: pointer;
        }

        .problem-actions button:hover {
            opacity: 0.8;
        }

        .ranking {
            background-color: white;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .ranking h4 {
            margin-top: 0;
            margin-bottom: 5px;
        }

        .ranking p {
            margin: 0;
        }

        #ranking-table th,
        #ranking-table td {
            border-bottom: 1px solid #ddd;
            text-align: left;
            padding: 10px;
        }

        #ranking-table th {
            background-color: #f2f2f2;
        }

        #ranking-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .participants-ranking button {
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #008cba;
            color: white;
            cursor: pointer;
            font-size: medium;
        }
    </style>
</head>
<body>
<!-- Menu Panel -->
<div class="menu">
    <div class="menu-left">
        <a class="menu-item" href="announcements.html">Announcements</a>
        <a class="menu-item" href="contests.html">Contests</a>
        <a class="menu-item" href="problems.html">Problems</a>
    </div>
    <div class="menu-right">
        <a class="menu-item" href="userProfile.html">Profile</a>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <div class="content">
        <button
                onclick="deleteContest()"
                id="delete-contest-btn"
                style="
                        margin-bottom: 20px;
                        padding: 10px 20px;
                        background-color: red;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        display: none;
                    "
        >
            Delete Contest
        </button>

        <!-- Announcements Form (for admins) -->
        <div class="create-announcement-form" id="create-form" style="display: none;">
            <input
                    type="text"
                    id="new-title"
                    placeholder="Announcement Title"
            />
            <textarea
                    id="new-content"
                    rows="5"
                    placeholder="Announcement Content"
            ></textarea>
            <button onclick="submitAnnouncement()">Add Announcement</button>
        </div>

        <!-- Ranking -->
        <div class="participants-ranking">
            <button onclick="viewRanking()">View Ranking</button>
            <div
                    id="ranking-container"
                    style="display: none; margin-top: 20px"
            >
                <table
                        id="ranking-table"
                        style="width: 100%; border-collapse: collapse"
                >
                    <thead>
                    <tr>
                        <th
                                style="
                                            border-bottom: 2px solid #ddd;
                                            padding: 10px;
                                        "
                        >
                            Rank
                        </th>
                        <th
                                style="
                                            border-bottom: 2px solid #ddd;
                                            padding: 10px;
                                        "
                        >
                            Participant Name
                        </th>
                        <th
                                style="
                                            border-bottom: 2px solid #ddd;
                                            padding: 10px;
                                        "
                        >
                            Problems Solved
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Rankings will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Announcements List -->
        <div class="announcement-list" id="announcements-container">
            <!-- Announcements will be loaded here -->
        </div>

        <!-- Add Problem to Contest Form -->
        <div class="create-announcement-form" id="enter-problem" style="display: none">
            <input
                    type="number"
                    placeholder="Enter Problem ID"
                    style="
                            width: 30%;
                            padding: 10px;
                            border-radius: 5px;
                            border: 1px solid #ccc;
                        "
            />
            <button
                    onclick="handleAddProblem()"
                    style="margin-left: 7px"
            >
                Add Problem
            </button>
        </div>

        <!-- Problems List -->
        <div class="problem-list" id="problems-container">
            <!-- Problems will be loaded here -->
        </div>
    </div>

    <!-- User Info Section -->
    <div class="user-info">
        <img src="" alt="" id="user-icon" width="100"/>
        <h2 id="user-name">Username</h2>
        <div class="user-stats">
            <p>
                <strong>Problems Solved:</strong>
                <span id="problems-solved">0</span>
            </p>
            <p>
                <strong>Max Performance:</strong>
                <span id="max-performance">0</span>
            </p>
            <p><strong>Rating:</strong> <span id="rating">0</span></p>
            <p>
                <strong>Max Rating:</strong>
                <span id="max-rating">0</span>
            </p>
        </div>
    </div>
</div>

<script>

    let isAdmin = false;

    async function fetchUserData() {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("You must be logged in to view this page.");
            window.location.href = "/index/"; // Redirect to login if no token
        }
        try {
            const userResponse = await fetch("/user-info/", {
                method: "GET",
                headers: {Authorization: `Bearer ${token}`},
            });

            if (userResponse.ok) {
                const userData = await userResponse.json();
                isAdmin = userData.role === "admin";
                document.getElementById("user-name").innerText =
                    userData.username;
                // Show the "Create Contest" button if the user is an admin
                if (isAdmin) {
                    document.getElementById("create-form").style.display = "block";
                    document.getElementById("delete-contest-btn").style.display = "block";
                    document.getElementById("enter-problem").style.display = "block";
                    // document.getElementById("handle-add-problem-btn").style.display = "block";
                }

                // Update achievements
                const achievementsResponse = await fetch(
                    "/user-achievements/",
                    {
                        method: "GET",
                        headers: {Authorization: `Bearer ${token}`},
                    }
                );
                if (achievementsResponse.ok) {
                    const achievements =
                        await achievementsResponse.json();
                    document.getElementById(
                        "problems-solved"
                    ).innerText = achievements.problems_solve;
                    document.getElementById(
                        "max-performance"
                    ).innerText = achievements.max_performance;
                    document.getElementById("rating").innerText =
                        achievements.rating;
                    document.getElementById("max-rating").innerText =
                        achievements.max_rating;
                } else {
                    // Handle no achievements case
                    document.getElementById(
                        "problems-solved"
                    ).innerText = "N/A";
                    document.getElementById(
                        "max-performance"
                    ).innerText = "N/A";
                    document.getElementById("rating").innerText = "N/A";
                    document.getElementById("max-rating").innerText =
                        "N/A";
                }

                await loadAnnouncements();
            } else {
                alert("Failed to fetch user data.");
                window.location.href = "/index/"; // Redirect to login on failure
            }
        } catch (error) {
            console.error("Error fetching user data:", error);
            alert("An error occurred while fetching user data.");
            window.location.href = "/index/"; // Redirect to login on error
        }
    }


    document.addEventListener("DOMContentLoaded", async function () {
        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get("contestId");
        const token = localStorage.getItem("token");

        document.getElementById('delete-contest-button').onclick = deleteContest;
        if (!contestId) {
            console.error("Contest ID is missing from the URL.");
            alert("Contest ID is missing from the URL.");
            return;
        }

        console.log(`Contest ID: ${contestId}`); // Debugging line

        if (!token) {
            console.error("Token is missing.");
            alert("You must be logged in to view this page.");
            return;
        }

        try {
            const response = await fetch(`/contests/${contestId}`, {
                method: "GET",
                headers: {Authorization: `Bearer ${token}`},
            });

            if (response.ok) {
                const contest = await response.json();

            } else if (response.status === 404) {
                console.error("Contest not found.");
                alert("Contest not found.");
            } else {
                console.error("Failed to load contest details:", response.statusText);
                alert("Failed to load contest details.");
            }
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("An error occurred while fetching data.");
        }
    });
    const problems = [
        {id: 1, title: "Problem 1"},
        {id: 2, title: "Problem 2"},
        {id: 3, title: "Problem 3"},
    ];

    const participants = [
        {name: "Participant 1", score: 2},
        {name: "Participant 2", score: 1},
        {name: "Participant 3", score: 3},
    ];

    // Function to load announcements
    async function loadAnnouncements() {
        const container = document.getElementById("announcements-container");
        container.innerHTML = ""; // Clear existing content

        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get("contestId");
        const token = localStorage.getItem("token");

        if (!contestId) {
            console.error("Contest ID is missing from the URL.");
            return;
        }

        if (!token) {
            alert("You must be logged in to view announcements.");
            window.location.href = "/index/";
            return;
        }

        try {
            const response = await fetch(`/contest/${contestId}/announcements`, {
                method: 'GET',
                headers: {Authorization: `Bearer ${token}`},
            });

            if (response.ok) {
                const announcements = await response.json();
                console.log("Fetched announcements:", announcements); // Debugging line

                announcements.forEach((announcement) => {
                    const announcementElement = document.createElement("div");
                    announcementElement.className = "announcement";

                    const title = document.createElement("h3");
                    title.textContent = announcement.title;
                    announcementElement.appendChild(title);

                    const content = document.createElement("p");
                    content.textContent = announcement.content;
                    announcementElement.appendChild(content);

                    const datePosted = document.createElement("p");
                    datePosted.className = "date-posted";

                    // Assuming announcement.date_posted is in ISO format, convert it to a more readable format
                    const date = new Date(announcement.date_posted);
                    datePosted.textContent = `Posted on: ${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
                    announcementElement.appendChild(datePosted);

                    container.appendChild(announcementElement);
                });
            } else {
                const errorData = await response.json();
                alert(`Failed to load announcements: ${errorData.detail || response.statusText}`);
            }
        } catch (error) {
            console.error("Error fetching announcements:", error);
            alert("An error occurred while fetching announcements.");
        }
    }

    async function submitAnnouncement() {
        const title = document.getElementById('new-title').value;
        const content = document.getElementById('new-content').value;
        const token = localStorage.getItem('token');

        // Get contest ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get('contestId');

        if (!title || !content) {
            alert('Please fill in both the title and content.');
            return;
        }

        if (!token) {
            alert('You must be logged in to submit an announcement.');
            window.location.href = '/index/';
            return;
        }

        try {
            // Step 1: Create the announcement
            const response = await fetch('/announcements/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                alert(`Failed to create announcement: ${errorData.detail || response.statusText}`);
                return;
            }

            const newAnnouncement = await response.json();
            const announcementId = newAnnouncement.announcement_id;

            // Step 2: Associate the announcement with the contest
            const linkResponse = await fetch(`/contest/${contestId}/announcement/${announcementId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (linkResponse.ok) {
                alert('Announcement added successfully!');
                window.location.reload();
                // Optionally, refresh the page or update the UI to show the new announcement
            } else {
                const errorData = await linkResponse.json();
                alert(`Failed to link announcement to contest: ${errorData.detail || linkResponse.statusText}`);
            }

        } catch (error) {
            console.error('Error submitting announcement:', error);
            alert('An error occurred while submitting the announcement.');
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadProblems();
    });

    // Function to load problems
    async function loadProblems() {
        const container = document.getElementById('problems-container');
        container.innerHTML = ""; // Clear existing content

        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get("contestId");
        const token = localStorage.getItem("token");

        if (!contestId) {
            console.error("Contest ID is missing from the URL.");
            return;
        }

        if (!token) {
            alert("You must be logged in to view problems.");
            window.location.href = "/index/";
            return;
        }

        try {
            const response = await fetch(`/contest/${contestId}`, {
                method: 'GET',
                headers: {Authorization: `Bearer ${token}`},
            });

            if (response.ok) {
                const problems = await response.json();
                console.log("Fetched problems:", problems); // Debugging line

                // Render problems
                problems.forEach(problem => {
                    const problemElement = document.createElement('div');
                    problemElement.className = 'problem';
                    problemElement.id = `problem-${problem.problem_id}`; // Set ID for removal

                    const titleElement = document.createElement('h3');
                    titleElement.textContent = problem.title;

                    const problemIdElement = document.createElement('p');
                    problemIdElement.innerHTML = `<a href="problem-detail.html?problemId=${problem.problem_id}" class="problem-id-link">Problem ${problem.problem_id}</a>`;
                    titleElement.appendChild(problemIdElement);

                    problemElement.appendChild(titleElement);

                    const actionsElement = document.createElement('div');
                    actionsElement.className = 'problem-actions';

                    // Add Remove button
                    if (isAdmin) {
                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.className = 'remove-button'; // Add class for easier selection
                        removeButton.setAttribute('data-problem-id', problem.problem_id); // Set data attribute
                        removeButton.setAttribute('data-contest-id', contestId); // Set data attribute
                        removeButton.onclick = function () {
                            const problemId = this.getAttribute('data-problem-id');
                            const contestId = this.getAttribute('data-contest-id');
                            removeProblemFromContest(problemId, contestId);
                        };
                        actionsElement.appendChild(removeButton);
                    }


                    problemElement.appendChild(actionsElement);
                    container.appendChild(problemElement);
                });
            } else {
                const errorData = await response.json();
                alert(`Failed to load problems: ${errorData.detail || response.statusText}`);
            }
        } catch (error) {
            console.error("Error fetching problems:", error);
            alert("An error occurred while fetching problems.");
        }
    }


    async function handleAddProblem() {
        const problemId = document.getElementById('problem-id-input').value;

        if (!problemId) {
            alert("Problem ID is required.");
            return;
        }

        await addProblemToContest(problemId);
    }

    // Function to add a problem to the contest
    async function addProblemToContest(problemId) {
        const token = localStorage.getItem("token");
        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get("contestId");

        if (!token) {
            alert("You must be logged in to add problems.");
            window.location.href = "/index/";
            return;
        }

        if (!contestId) {
            alert("Contest ID is missing from the URL.");
            return;
        }
        if (!problemId) {
            alert("Problem ID is required.");
            return;
        }

        try {
            const response = await fetch(`/contest/${contestId}`, {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                    problem_id: problemId
                })
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message || "Problem added successfully!");
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert(`Failed to add problem: ${errorData.detail || response.statusText}`);
            }
        } catch (error) {
            console.error("Error adding problem:", error);
            alert("An error occurred while adding the problem.");
        }
    }

    // Function to remove a problem from the contest
    async function removeProblemFromContest(problemId, contestId) {
        const token = localStorage.getItem("token");

        if (!token) {
            alert("You must be logged in to remove a problem.");
            return;
        }

        if (!problemId || !contestId) {
            console.error("Problem ID or Contest ID is missing.");
            alert("Problem ID or Contest ID is missing.");
            return;
        }

        try {
            const response = await fetch(`/contest/${contestId}/problem/${problemId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                // Problem successfully removed
                alert("Problem removed successfully.");
                // Optionally, remove the problem element from the UI
                const problemElement = document.getElementById(`problem-${problemId}`);
                if (problemElement) {
                    problemElement.remove();
                }
            } else {
                // Handle errors
                const errorData = await response.json();
                alert(`Failed to remove problem: ${errorData.detail || response.statusText}`);
            }
        } catch (error) {
            console.error("Error removing problem:", error);
            alert("An error occurred while removing the problem.");
        }
    }

    async function loadParticipants(contestId) {
        try {
            const token = localStorage.getItem("token");
            const response = await fetch(`/participants/${contestId}`, {
                method: 'GET',
                headers: {Authorization: `Bearer ${token}`},
            });

            if (!response.ok) {
                throw new Error(`Failed to load participants: ${response.statusText}`);
            }

            const participants = await response.json();
            return participants;

        } catch (error) {
            console.error("Error fetching participants:", error);
            alert("An error occurred while fetching participants.");
            return [];
        }
    }

    async function viewRanking() {
        const contestId = new URLSearchParams(window.location.search).get("contestId");
        const rankingContainer = document.getElementById("ranking-container");

        if (rankingContainer.style.display === "block") {
            rankingContainer.style.display = "none"; // Hide the ranking container
        } else {
            const tbody = document.querySelector("#ranking-table tbody");
            tbody.innerHTML = ""; // Clear existing content

            const participants = await loadParticipants(contestId);

            participants.forEach((participant, index) => {
                const row = document.createElement("tr");

                const placeCell = document.createElement("td");
                placeCell.textContent = index + 1;
                placeCell.style.padding = "10px";
                row.appendChild(placeCell);

                const nameCell = document.createElement("td");
                nameCell.textContent = participant.username;
                nameCell.style.padding = "10px";
                row.appendChild(nameCell);

                const scoreCell = document.createElement("td");
                scoreCell.textContent = participant.score;
                scoreCell.style.padding = "10px";
                row.appendChild(scoreCell);

                tbody.appendChild(row);
            });

            rankingContainer.style.display = "block"; // Show the ranking container
        }
    }

    async function deleteContest() {
        const urlParams = new URLSearchParams(window.location.search);
        const contestId = urlParams.get("contestId");
        const token = localStorage.getItem("token"); // Get the token from local storage

        if (!contestId) {
            alert("Contest ID is missing.");
            return;
        }

        if (!token) {
            alert("You must be logged in to delete a contest.");
            return;
        }

        if (confirm("Are you sure you want to delete this contest?")) {
            try {
                const response = await fetch(`/contest/${contestId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert("Contest deleted successfully.");
                    window.location.href = "contests.html"; // Redirect to the contests page
                } else {
                    const errorData = await response.json();
                    alert(`Failed to delete contest: ${errorData.detail || response.statusText}`);
                }
            } catch (error) {
                console.error("Error deleting contest:", error);
                alert("An error occurred while deleting the contest.");
            }
        }
    }


    // Call the functions to load announcements and problems when the page loads
    // window.onload = function () {
    //     loadAnnouncements();
    //     loadProblems();
    // };
    fetchUserData();
</script>
</body>
</html>